# peppermint-api
The API runs on AWS API Gateway with operations handled by AWS Lambda. All
operations are in Node, but Java and Python are supported on Lambda as well. Any
individual operation can be written in a supported language without affecting
other operations.

The API uses DynamoDB for persistence. The recorders table holds credentials and
metadata about the installation. The short-url table maps pathnames on
peppermint.com to keys in the peppermint-cdn bucket, accessible through a
Cloudfront distribution. The developer resonsible for the API should subscribe
to DynaomDB capacity notifications so the read/write throughput can be increased
as needed.

Every operation has a spec file that is used both for documentation and for
generating the corresponding method in API Gateway. Some of the operations also
pull in the spec and use it to validate input with the JSON Schema 4 tiny
validator library tv4. If the spec diverges from the implementation there should
be errors. The definitions subdirectoy holds schemas used by multiple
operations. Refer to the swagger specification for writing the spec and for the
x-amazon-apigateway-integration extension use other operations as examples.

## Build
```
npm install
```
Set a secret for signing JWTs at least 40 characters long.
```
export PEPPERMINT_JWT_SECRET=abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN
```
Link the utils and definitions subdirectories into node_modules so they can be
required without leadding "./" or "../", etc.
```
cd node_modules
ln -s ../definitions ./
ln -s ../utils ./
```

For Lambda, set the env vars as keys in utils/conf.json, which is not checked
into git but is uploaded to Lambda with the gulp lambda task.

## Docs
```
npm serve
```
Then open http://localhost:3000/docs/?url=/swagger.json in your browser.
Run ```gulp publishSpec``` to publish the docs to [S3](https://s3-us-west-2.amazonaws.com/peppermint-assets/dist/index.html?url=/peppermint-assets/swagger.json).
The API is CORS-enabled so it can be tested directly from the Swagger-UI docs.

## Deploy
The swagger build task generates a swagger.json from the code. The
aws-apigateway-swagger-importer submodule provides a script to generate an API
from a swagger.json file.
Before using the import tool, ensure the submodule was cloned (hint: ```git clone
--recursive```), install maven on your system, and build the tool with ```mvn
assembly:assembly```. To create the API the first time, run:
```
cd build/aws-apigateway-swagger-importer
./aws-api-import.sh --create ../../swagger.json
```
Watch the output for the api id. Log into the AWS console and deploy the API and
note the stage. This is a 1 time task.  For normal development, you'll only be
updating the API with:
```
./aws-api-import.sh --update API_ID --deploy STAGE ../../swagger.json
```
There is a gulp task ```deploy``` to run this command quickly.
Don't use the console to create or modify a resource or method and expect it to
be there after the next ```gulp deploy```

## Tests
Unit tests are in the subdirectory of the file they're testing. Run them with
```npm test```. Integration tests are all in the test directory. Run them with
```npm run integration-tests```.

## Logs and monitoring
All non-200 responses generated by the API are logged to CloudWatch along with
the entire request body and response from the Lambda function. Every invocation
of a Lambda function is logged to CloudWatch. The AWS console provides
dashboards for viewing metrics for API Gateway and Lambda.

## Environment Variables
* PEPPERMINT_JWT_SECRET
* PEPPERMINT_GCM_API_KEY
* PEPPERMINT_GCM_SENDER_ID
